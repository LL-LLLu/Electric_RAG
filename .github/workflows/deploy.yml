name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:  # Manual trigger from GitHub UI

jobs:
  # Run CI first - deploy is blocked until this passes
  ci:
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  # Only deploy after CI passes
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy Backend
        env:
          RENDER_DEPLOY_HOOK_BACKEND: ${{ secrets.RENDER_DEPLOY_HOOK_BACKEND }}
        if: env.RENDER_DEPLOY_HOOK_BACKEND != ''
        run: |
          echo "Triggering backend deploy..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$RENDER_DEPLOY_HOOK_BACKEND")
          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "201" ]; then
            echo "Backend deploy triggered successfully (HTTP $RESPONSE)"
          else
            echo "Backend deploy hook returned HTTP $RESPONSE"
            exit 1
          fi

      - name: Deploy Frontend
        env:
          RENDER_DEPLOY_HOOK_FRONTEND: ${{ secrets.RENDER_DEPLOY_HOOK_FRONTEND }}
        if: env.RENDER_DEPLOY_HOOK_FRONTEND != ''
        run: |
          echo "Triggering frontend deploy..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$RENDER_DEPLOY_HOOK_FRONTEND")
          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "201" ]; then
            echo "Frontend deploy triggered successfully (HTTP $RESPONSE)"
          else
            echo "Frontend deploy hook returned HTTP $RESPONSE"
            exit 1
          fi

      - name: No deploy hooks configured
        env:
          RENDER_DEPLOY_HOOK_BACKEND: ${{ secrets.RENDER_DEPLOY_HOOK_BACKEND }}
        if: env.RENDER_DEPLOY_HOOK_BACKEND == ''
        run: |
          echo "::warning::No RENDER_DEPLOY_HOOK_BACKEND secret configured."
          echo "Go to Render dashboard > Backend service > Settings > Build & Deploy > Deploy Hook"
          echo "Copy the URL and add it as a GitHub secret named RENDER_DEPLOY_HOOK_BACKEND"
          echo "Do the same for RENDER_DEPLOY_HOOK_FRONTEND"
